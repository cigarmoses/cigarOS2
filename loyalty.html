<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loyalty • cigarOS2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f2f2f2;
      --ink:#0b2b2e;
      --muted:#7e8a93;
      --blue:#1DA1F2;
      --orange:#FF6E4A;
      --rowEven:#f7fbff;
      --rowOdd:#ffffff;
      --rowLocker:#eaf5ff;
      --card:#fff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol";
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:900px;margin:0 auto;padding:16px 16px 88px}
    header{
      display:flex;align-items:center;gap:8px;margin:8px 0 12px;
    }
    header a.back{
      display:inline-flex;align-items:center;justify-content:center;
      width:36px;height:36px;border-radius:10px;background:#fff;border:1px solid #e7ecf0;
      text-decoration:none;color:var(--ink);font-weight:700;
    }
    header h1{margin:0 auto 0 8px;font-size:22px}
    .search{
      display:flex;gap:10px;align-items:center;margin:8px 0 12px;
    }
    .search input{
      flex:1;border:1px solid #e7ecf0;border-radius:14px;padding:14px 14px;font-size:16px;background:#fff;
    }
    .tabs{display:flex;gap:12px;margin-bottom:10px}
    .tab{
      flex:1;display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;border-radius:14px;border:1px solid #e7ecf0;background:#fff;font-weight:600;
    }
    .tab.lockers.active{outline:2px solid var(--blue);background:#eaf5ff}
    .tab.regs.active{outline:2px solid var(--orange);background:#fff2ed}
    .table{
      border-radius:16px;overflow:hidden;border:1px solid #e7ecf0;background:#fff;
    }
    .thead,.row{display:grid;grid-template-columns:1.2fr 80px 120px;gap:8px;padding:14px 16px}
    .thead{background:#f4f7fa;font-weight:800}
    .row:nth-child(even){background:var(--rowEven)}
    .row:nth-child(odd){background:var(--rowOdd)}
    .row.locker{background:var(--rowLocker)}
    .name{display:flex;align-items:center;gap:10px}
    .name .nick{display:block;color:var(--muted);font-weight:400;font-size:14px}
    .pts,.last{font-weight:700;text-align:right}
    .row a{color:inherit;text-decoration:none}
    .empty{padding:24px;text-align:center;color:var(--muted)}
    /* Modal */
    dialog{
      border:0;border-radius:18px;max-width:560px;width:calc(100% - 24px);padding:0;box-shadow:0 20px 40px rgba(0,0,0,.25)
    }
    .card{padding:18px}
    .card h2{margin:0 0 12px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:10px;padding:10px 0;border-top:1px solid #eef2f5}
    .kv:first-of-type{border-top:0}
    .x{position:absolute;top:10px;right:10px;border:0;background:#f3f4f6;border-radius:10px;width:34px;height:34px;font-size:18px}
    @media (max-width:560px){
      .thead,.row{grid-template-columns:1.3fr 60px 90px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="back" href="/">&larr;</a>
      <h1>Loyalty</h1>
    </header>

    <div class="search">
      <input id="q" type="search" placeholder="Search by name or nickname…">
    </div>

    <div class="tabs">
      <button id="tLock" class="tab lockers active">
        <span>Lockers</span><span>▼</span>
      </button>
      <button id="tRegs" class="tab regs">
        <span>Regulars</span><span>▼</span>
      </button>
    </div>

    <div class="table">
      <div class="thead">
        <div>Name</div><div class="pts">Pts</div><div class="last">Last Visit</div>
      </div>
      <div id="rows"></div>
      <div id="empty" class="empty" hidden>No matching customers.</div>
    </div>
  </div>

  <!-- Modal -->
  <dialog id="sheet">
    <form method="dialog" class="card">
      <button class="x" value="close" aria-label="Close">✕</button>
      <h2 id="mName">Customer</h2>
      <div class="kv"><div>Nickname</div><div id="mNick">—</div></div>
      <div class="kv"><div>Phone</div><div id="mPhone">—</div></div>
      <div class="kv"><div>Email</div><div id="mEmail">—</div></div>
      <div class="kv"><div>Birthday</div><div id="mBday">—</div></div>
      <div class="kv"><div>Points</div><div id="mPts">0</div></div>
    </form>
  </dialog>

  <script>
    const rowsEl = document.getElementById('rows');
    const emptyEl = document.getElementById('empty');
    const qEl = document.getElementById('q');
    const sheet = document.getElementById('sheet');

    const m = {
      name: document.getElementById('mName'),
      nick: document.getElementById('mNick'),
      phone: document.getElementById('mPhone'),
      email: document.getElementById('mEmail'),
      bday: document.getElementById('mBday'),
      pts: document.getElementById('mPts'),
    };

    let ALL = [];        // raw contacts
    let MODE = 'lock';   // 'lock' or 'reg'
    let QUERY = '';

    const normalize = (s) => (s || '').toString().trim();
    const safeDate = (s) => normalize(s);

    function toName(o){
      const f = normalize(o.First || o.first || o.FIRST || o.first_name);
      const l = normalize(o.Last || o.last || o.LAST || o.last_name);
      return (f + ' ' + l).trim();
    }

    function isLocker(o){
      // try common locker fields: Locker, locker, locker_number
      const raw = (o.Locker ?? o.locker ?? o['locker number'] ?? o.locker_number ?? '').toString().trim();
      if (raw === '') return false;
      // treat any non-empty (or >0) as locker
      if (/^\d+$/.test(raw)) return parseInt(raw,10) > 0;
      return true;
    }

    function lastVisit(o){
      return normalize(o['Last Visit'] ?? o.last_visit ?? o.LastVisit ?? '—');
    }

    function points(o){
      const p = normalize(o.Points ?? o.points ?? '0');
      return p === '' ? '0' : p;
    }

    function nickname(o){
      return normalize(o.Nickname ?? o.nickname ?? o.AKA ?? '');
    }

    function phone(o){ return normalize(o.Phone ?? o.phone ?? ''); }
    function email(o){ return normalize(o.Email ?? o.email ?? ''); }
    function bday(o){  return normalize(o.Birthday ?? o.birthday ?? ''); }

    function render(){
      const list = ALL.filter(o => (MODE === 'lock' ? isLocker(o) : !isLocker(o)))
        .filter(o => {
          if (!QUERY) return true;
          const n = (toName(o) + ' ' + nickname(o)).toLowerCase();
          return n.includes(QUERY);
        });

      rowsEl.innerHTML = '';
      emptyEl.hidden = list.length > 0;

      for (const o of list){
        const r = document.createElement('div');
        r.className = `row ${isLocker(o) ? 'locker' : ''}`;
        const nameHtml = `
          <a href="#" class="n">
            <div class="name">
              <div>
                <div class="full" style="font-weight:800">${toName(o) || '—'}</div>
                <small class="nick">${nickname(o) || ''}</small>
              </div>
            </div>
          </a>`;
        r.innerHTML = `
          <div>${nameHtml}</div>
          <div class="pts">${points(o)}</div>
          <div class="last">${lastVisit(o) || '—'}</div>
        `;
        r.querySelector('.n').addEventListener('click', (ev) => {
          ev.preventDefault();
          m.name.textContent = toName(o) || 'Customer';
          m.nick.textContent = nickname(o) || '—';
          const ph = phone(o) || '—';
          const em = email(o) || '—';
          m.phone.innerHTML = ph && ph !== '—' ? `<a href="tel:${ph}">${ph}</a>` : '—';
          m.email.innerHTML = em && em !== '—' ? `<a href="mailto:${em}">${em}</a>` : '—';
          m.bday.textContent = bday(o) || '—';
          m.pts.textContent = points(o);
          sheet.showModal();
        });
        rowsEl.appendChild(r);
      }
    }

    async function loadContacts(){
      try{
        const res = await fetch('/.netlify/functions/get-contacts');
        const out = await res.json();
        if (!out.ok) throw new Error(out.error || 'failed');
        ALL = out.contacts || [];
      }catch(e){
        console.error('contacts load failed', e);
        ALL = [];
      }
      render();
    }

    // Events
    document.getElementById('tLock').addEventListener('click', () => {
      MODE = 'lock';
      document.getElementById('tLock').classList.add('active');
      document.getElementById('tRegs').classList.remove('active');
      render();
    });
    document.getElementById('tRegs').addEventListener('click', () => {
      MODE = 'reg';
      document.getElementById('tRegs').classList.add('active');
      document.getElementById('tLock').classList.remove('active');
      render();
    });
    qEl.addEventListener('input', () => { QUERY = qEl.value.trim().toLowerCase(); render(); });

    // go
    loadContacts();
  </script>
</body>
</html>
